<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:linear-gradient(135deg,#f5f7fa,#c3cfe2);min-height:100vh}.container{max-width:900px;margin-top:40px}</style>
</head>
<body>
  <div class="container bg-white rounded shadow p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 id="adminHeader">Admin Dashboard</h3>
      <div>
        <a href="/predict" class="btn btn-sm btn-success me-2">Open Predict</a>
        <button id="btnLogout" class="btn btn-sm btn-outline-secondary">Logout</button>
      </div>
    </div>

    <div id="msg"></div>
    <div id="retrainMsg" style="margin-top:8px"></div>

    <div class="mt-3 mb-3">
      <label class="form-label">IoT Broker</label>
      <div class="input-group mb-2">
        <input id="iotBroker" class="form-control" placeholder="mqtt://broker.example or IP" />
        <input id="iotTopic" class="form-control" placeholder="topic (e.g. sensors/#)" />
        <button id="btnIotStart" class="btn btn-sm btn-outline-success">Start MQTT</button>
        <button id="btnIotStop" class="btn btn-sm btn-outline-danger">Stop MQTT</button>
      </div>
      <div id="iotLatest" class="text-muted">No IoT data yet</div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5>Registered Users</h5>
      <div class="d-flex gap-2 align-items-center">
        <input id="searchInput" class="form-control form-control-sm" placeholder="Search by name or mobile" style="width:260px;">
        <button id="btnRefresh" class="btn btn-sm btn-outline-primary">Refresh</button>
      </div>
    </div>

    <div id="usersArea" class="table-responsive">
      <table class="table table-striped">
        <thead><tr><th>ID</th><th>Name</th><th>Mobile</th><th>Address</th><th>Created</th><th>Actions</th></tr></thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const token = localStorage.getItem('adminToken');
    if(!token) location.href = '/admin/login';

    function $(id){ return document.getElementById(id); }

    // Defensive bindings
    if($('btnLogout')) {
      $('btnLogout').addEventListener('click', ()=>{
        localStorage.removeItem('adminToken');
        location.href = '/admin/login';
      });
    }

    if($('btnRefresh')) {
      $('btnRefresh').addEventListener('click', ()=> {
        fetch('/api/admin/users', { headers: {'X-Admin-Token': token} })
          .then(res => res.json())
          .then(() => location.reload())
          .catch(()=>{});
      });
    }

    // Placeholder: fetch users and render if backend route available
    async function fetchUsers(){
      try{
        const res = await fetch('/api/admin/users', { headers: {'X-Admin-Token': token} });
        if(!res.ok) return;
        const data = await res.json();
        window._adminUsers = data.users || [];
        renderUserTable(window._adminUsers);
      }catch(e){}
    }

    function renderUserTable(users){
      const tbody = $('usersTbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.id}</td><td>${u.name}</td><td>${u.mobile}</td><td>${u.address}</td><td>${u.created_at}</td><td class="table-actions"><button data-id="${u.id}" class="btn btn-sm btn-danger btn-delete">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.btn-delete').forEach(b=> b.addEventListener('click', deleteUser));
    }

    async function deleteUser(e){
      const id = e.currentTarget.getAttribute('data-id');
      if(!confirm('Delete user ID '+id+'?')) return;
      try{
        const res = await fetch(`/api/admin/user/${id}/delete`, { method:'POST', headers: {'X-Admin-Token': token} });
        if(res.ok) fetchUsers();
      }catch(e){}
    }

    // initialize
    fetchUsers();
  </script>
</body>
</html>